class d{strictMode;nudityThreshold;constructor(t=!1,e=5){this.strictMode=t,this.nudityThreshold=e}async analyzeImage(t){const e={nudityLevel:0,isProblematic:!1,confidence:.8,reasons:[]},s=t.toLowerCase();return s.includes("nsfw")||s.includes("adult")||s.includes("explicit")?(e.nudityLevel=9,e.isProblematic=!0,e.reasons.push("URL contains explicit keywords")):(s.includes("bikini")||s.includes("swimwear"))&&(e.nudityLevel=4,e.isProblematic=this.strictMode,e.reasons.push("URL suggests swimwear content")),e}setStrictMode(t){this.strictMode=t}setNudityThreshold(t){this.nudityThreshold=t}getStrictMode(){return this.strictMode}getNudityThreshold(){return this.nudityThreshold}}class h{observer=null;detectedElements=new Set;stats={totalImages:0,backgroundImages:0,imgElements:0};extractImageSrc(t){return t.src?t.src:t.dataset.src?t.dataset.src:t.getAttribute("data-lazy-src")?t.getAttribute("data-lazy-src"):null}extractBackgroundImage(t){const s=window.getComputedStyle(t).backgroundImage;if(s&&s!=="none"){const i=s.match(/url\(['"]?([^'"]+)['"]?\)/);if(i&&i[1])return i[1]}return null}processElement(t){const e=[];if(t.tagName==="IMG"){const i=t,r=this.extractImageSrc(i);r&&!this.detectedElements.has(t)&&(e.push({element:t,src:r,type:"img"}),this.detectedElements.add(t),this.stats.imgElements++,this.stats.totalImages++)}const s=this.extractBackgroundImage(t);return s&&!this.detectedElements.has(t)&&(e.push({element:t,src:s,type:"background"}),this.detectedElements.add(t),this.stats.backgroundImages++,this.stats.totalImages++),e}detectImages(){const t=[];return document.querySelectorAll("img").forEach(r=>{const a=this.extractImageSrc(r);a&&(t.push({element:r,src:a,type:"img"}),this.detectedElements.add(r),this.stats.imgElements++)}),document.querySelectorAll("*").forEach(r=>{const a=r,n=this.extractBackgroundImage(a);n&&!this.detectedElements.has(a)&&(t.push({element:a,src:n,type:"background"}),this.detectedElements.add(a),this.stats.backgroundImages++)}),document.querySelectorAll("video").forEach(r=>{const a=r;a.poster&&(t.push({element:a,src:a.poster,type:"video"}),this.detectedElements.add(a))}),this.stats.totalImages=t.length,t}startObserving(t){this.observer&&this.stopObserving(),this.observer=new MutationObserver(e=>{const s=[];e.forEach(i=>{if(i.type==="childList")i.addedNodes.forEach(r=>{if(r.nodeType===Node.ELEMENT_NODE){const a=r,n=this.processElement(a);s.push(...n),a.querySelectorAll("img, *").forEach(l=>{const c=this.processElement(l);s.push(...c)})}});else if(i.type==="attributes"){const r=i.target;if(i.attributeName==="src"||i.attributeName==="data-src"||i.attributeName==="data-lazy-src"||i.attributeName==="style"||i.attributeName==="class"){const a=this.processElement(r);s.push(...a)}}}),s.length>0&&(console.log(`ImageDetector: Found ${s.length} new images`),t(s))}),this.observer.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","data-src","data-lazy-src","style","class"]})}stopObserving(){this.observer&&(this.observer.disconnect(),this.observer=null)}clearCache(){this.detectedElements.clear(),this.stats={totalImages:0,backgroundImages:0,imgElements:0}}getStats(){return{...this.stats}}addVisualIndicators(){this.detectedElements.forEach(t=>{t.style.border="2px solid red",t.style.boxSizing="border-box"})}}class g{settings;filteredElements=new Set;stats={totalProcessed:0,totalBlocked:0,totalAllowed:0};constructor(t){this.settings={...t}}applyFilter(t,e){if(this.stats.totalProcessed++,this.isInAllowList(t.src)){this.allowImage(t);return}if(this.isInBlockList(t.src)){this.blockImage(t);return}e.isProblematic||e.nudityLevel>this.settings.nudityThreshold?this.blockImage(t):this.allowImage(t)}blockImage(t){const e=t.element;if(!this.filteredElements.has(e)){switch(this.filteredElements.add(e),this.stats.totalBlocked++,t.type){case"img":this.blockImgElement(e);break;case"background":this.blockBackgroundImage(e);break;case"video":this.blockVideoElement(e);break}console.log(`ImageFilter: Blocked ${t.type} image: ${t.src}`)}}allowImage(t){this.stats.totalAllowed++}blockImgElement(t){t.style.display="none";const e=document.createElement("div");e.className="clean-web-blocked-image",e.textContent="ðŸš« Image blocked by Clean Web",e.style.cssText=`
      display: inline-block;
      background: #f0f0f0;
      border: 2px dashed #ccc;
      padding: 20px;
      text-align: center;
      color: #666;
      font-family: Arial, sans-serif;
      font-size: 14px;
    `,t.parentNode?.insertBefore(e,t)}blockBackgroundImage(t){t.style.backgroundImage="none",t.style.backgroundColor="#f0f0f0";const e=t.getBoundingClientRect();if(e.width>50&&e.height>50){const s=document.createElement("div");s.textContent="ðŸš«",s.style.cssText=`
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 24px;
        z-index: 1000;
      `,getComputedStyle(t).position==="static"&&(t.style.position="relative"),t.appendChild(s)}}blockVideoElement(t){t.poster=""}isInAllowList(t){return this.settings.allowList.some(e=>t.includes(e))}isInBlockList(t){return this.settings.blockList.some(e=>t.includes(e))}updateSettings(t){this.settings={...this.settings,...t}}getSettings(){return{...this.settings}}getStats(){return{...this.stats}}clearAll(){this.filteredElements.forEach(t=>{const e=t;e.tagName==="IMG"?e.style.display="":(t.style.backgroundImage="",t.style.backgroundColor=""),t.parentNode?.querySelectorAll(".clean-web-blocked-image")?.forEach(i=>i.remove())}),this.filteredElements.clear(),this.stats={totalProcessed:0,totalBlocked:0,totalAllowed:0}}}class u{classifier;detector;filter;isRunning=!1;constructor(t){this.classifier=new d(t.strictMode,t.nudityThreshold),this.detector=new h,this.filter=new g(t)}async start(){this.isRunning||(this.isRunning=!0,console.log("CleanWebCore: Starting..."),await this.processExistingImages(),this.detector.startObserving(async t=>{await this.processImages(t)}),console.log("CleanWebCore: Started successfully"))}stop(){this.isRunning&&(console.log("CleanWebCore: Stopping..."),this.isRunning=!1,this.detector.stopObserving(),this.filter.clearAll(),console.log("CleanWebCore: Stopped"))}async processExistingImages(){const t=this.detector.detectImages();console.log(`CleanWebCore: Found ${t.length} existing images`),await this.processImages(t)}async processImages(t){const e=t.map(async s=>{try{const i=await this.classifier.analyzeImage(s.src);this.filter.applyFilter(s,i)}catch(i){console.warn("Failed to process image:",s.src,i)}});await Promise.all(e)}updateSettings(t){this.filter.updateSettings(t),t.strictMode!==void 0&&this.classifier.setStrictMode(t.strictMode),t.nudityThreshold!==void 0&&this.classifier.setNudityThreshold(t.nudityThreshold)}getSettings(){return this.filter.getSettings()}getStats(){return{...this.filter.getStats(),...this.detector.getStats(),isRunning:this.isRunning}}async refresh(){this.isRunning&&await this.processExistingImages()}addVisualIndicators(){this.detector.addVisualIndicators()}}const m={nudityThreshold:5,strictMode:!1,allowList:[],blockList:[]};class b{core;stats={totalImages:0,backgroundImages:0,imgElements:0};constructor(){this.core=new u(m),this.initialize()}async initialize(){console.log("Clean Web Extension: Initializing..."),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>this.start()):this.start()}async start(){try{await this.core.start(),this.core.addVisualIndicators(),this.updateStats(),setInterval(()=>this.updateStats(),1e3),console.log("Clean Web Extension: Started successfully")}catch(t){console.error("Clean Web Extension: Failed to start",t)}}updateStats(){const t=this.core.getStats();this.stats={totalImages:t.totalImages||0,backgroundImages:t.backgroundImages||0,imgElements:t.imgElements||0},typeof chrome<"u"&&chrome.runtime&&chrome.runtime.sendMessage({type:"STATS_UPDATE",stats:this.stats}).catch(()=>{}),console.log("Clean Web Stats:",this.stats)}getStats(){return{...this.stats}}}const f=new b;window.cleanWebExtension=f;
